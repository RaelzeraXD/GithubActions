name: Push-to-EC2
on:
  push:
    branches: main

jobs:
  Deploy_to_ec2:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22.1'

    - name: Build Go
      run: go build -o main ./cloudformation/main.go

    - name: setup keys
      uses: kielabokkie/ssh-key-and-known-hosts-action@v1
      with:
        ssh-private-key: ${{ secrets.EC2_SSH }}
        ssh-host: ${{ secrets.REMOTE_HOST }}

    - name: Deploy
      run: rsync -a ./main ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:~

    - name: Run
      env:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH }}
        SSH_KNOWN_HOSTS: ${{ secrets.REMOTE_HOST }}
      run: |
        echo "${SSH_PRIVATE_KEY}" > /tmp/private_key
        chmod 400 /tmp/private_key
        sudo pkill -9 main
        ssh -i "/tmp/private_key" ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "sudo ./main"